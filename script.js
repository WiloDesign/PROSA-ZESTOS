// Detectar el scroll y cambiar la transparencia del header
window.addEventListener('scroll', () => {
    const header = document.querySelector('header');
    if (window.scrollY > 50) {
        header.classList.add('scrolled'); // Agregar clase cuando se hace scroll
    } else {
        header.classList.remove('scrolled'); // Quitar clase cuando se vuelve al inicio
    }
});

// AnimaciÃ³n de apariciÃ³n al hacer scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: "0px 0px -100px 0px"
};

const fadeInElements = document.querySelectorAll('.benefit, .testimonial, .product-details, #no-decidido');

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('fade-in-visible');
            observer.unobserve(entry.target);
        }
    });
}, observerOptions);

fadeInElements.forEach(element => {
    element.classList.add('fade-in');
    observer.observe(element);
});

// Scroll automÃ¡tico al hacer clic en los enlaces del menÃº
document.querySelectorAll('.menu li a').forEach(link => {
    link.addEventListener('click', (event) => {
        event.preventDefault(); // Evitar el comportamiento predeterminado del enlace
        const targetId = link.getAttribute('href').substring(1); // Obtener el ID del destino
        const targetElement = document.getElementById(targetId); // Seleccionar el elemento destino
        if (targetElement) {
            // AÃ±adir un desplazamiento para compensar el header fijo
            const headerHeight = document.querySelector('header').offsetHeight;
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
            
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
    });
});

// Sistema de carrusel mejorado con animaciones
const images = document.querySelectorAll('.carousel-images img');
const prevButton = document.querySelector('.carousel-button.prev');
const nextButton = document.querySelector('.carousel-button.next');
const dots = document.querySelectorAll('.dot');
let currentIndex = 0;
let autoSlideInterval;

// Iniciar el carrusel automÃ¡tico
function startAutoSlide() {
    autoSlideInterval = setInterval(() => {
        nextSlide();
    }, 5000); // Cambiar cada 5 segundos
}

function stopAutoSlide() {
    clearInterval(autoSlideInterval);
}

function updateCarousel() {
    // Eliminar clases activas de todas las imÃ¡genes
    images.forEach(img => img.classList.remove('active', 'slide-in-right', 'slide-in-left'));
    
    // Agregar clase activa a la imagen actual con animaciÃ³n
    if (images[currentIndex]) {
        images[currentIndex].classList.add('active');
        
        // AÃ±adir animaciÃ³n basada en la direcciÃ³n del deslizamiento
        const direction = images[currentIndex].dataset.direction;
        if (direction === 'right') {
            images[currentIndex].classList.add('slide-in-right');
        } else if (direction === 'left') {
            images[currentIndex].classList.add('slide-in-left');
        }
    }
    
    // Actualizar los indicadores
    updateIndicators();
}

function prevSlide() {
    images[currentIndex].dataset.direction = 'left';
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    updateCarousel();
}

function nextSlide() {
    images[currentIndex].dataset.direction = 'right';
    currentIndex = (currentIndex + 1) % images.length;
    updateCarousel();
}

function updateIndicators() {
    dots.forEach((dot, index) => {
        dot.classList.toggle('active-dot', index === currentIndex);
    });
}

// Configurar listeners para botones de carrusel
prevButton.addEventListener('click', () => {
    stopAutoSlide();
    prevSlide();
    startAutoSlide();
});

nextButton.addEventListener('click', () => {
    stopAutoSlide();
    nextSlide();
    startAutoSlide();
});

// Hacer que los puntos indicadores sean clicables
dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
        if (index > currentIndex) {
            images[currentIndex].dataset.direction = 'right';
        } else if (index < currentIndex) {
            images[currentIndex].dataset.direction = 'left';
        }
        currentIndex = index;
        updateCarousel();
        stopAutoSlide();
        startAutoSlide();
    });
});

// Detener autoSlide cuando el cursor estÃ¡ sobre el carrusel
const carousel = document.querySelector('.carousel');
carousel.addEventListener('mouseenter', stopAutoSlide);
carousel.addEventListener('mouseleave', startAutoSlide);

// Contador de productos disponibles (efecto psicolÃ³gico de escasez)
function iniciarContadorDisponibilidad() {
    const productInfo = document.querySelector('.product-info');
    if (!productInfo) return;
    
    const disponibilidadElement = document.createElement('div');
    disponibilidadElement.className = 'product-availability';
    
    // NÃºmero inicial aleatorio entre 3 y 10
    const disponibilidadInicial = Math.floor(Math.random() * 8) + 3;
    disponibilidadElement.innerHTML = `<p>Â¡Solo quedan <span class="availability-count">${disponibilidadInicial}</span> unidades en stock!</p>`;
    
    // Insertar despuÃ©s del precio
    const precioElement = document.querySelector('.product-price');
    if (precioElement) {
        precioElement.after(disponibilidadElement);
    }
    
    // Decrementar aleatoriamente durante la visita
    setTimeout(() => {
        const countElement = document.querySelector('.availability-count');
        if (countElement && parseInt(countElement.textContent) > 1) {
            countElement.textContent = parseInt(countElement.textContent) - 1;
            countElement.classList.add('flash');
            setTimeout(() => {
                countElement.classList.remove('flash');
            }, 1000);
        }
    }, 45000); // 45 segundos despuÃ©s
}

// AÃ±adir al carrito con animaciÃ³n
function aÃ±adirAlCarrito() {
    const button = document.querySelector('.product-info .cta-button');
    button.classList.add('button-pressed');
    
    // Crear elemento de notificaciÃ³n
    const notification = document.createElement('div');
    notification.className = 'cart-notification';
    notification.textContent = 'ðŸ›’ Producto aÃ±adido al carrito';
    document.body.appendChild(notification);
    
    // Animar notificaciÃ³n
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    // Eliminar notificaciÃ³n despuÃ©s de 3 segundos
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 500);
    }, 3000);
    
    // Quitar efecto presionado del botÃ³n
    setTimeout(() => {
        button.classList.remove('button-pressed');
    }, 300);
}

// FunciÃ³n para ir a la secciÃ³n de compra
function scrollToCompra() {
    const compraSection = document.getElementById('compra');
    if (compraSection) {
        const headerHeight = document.querySelector('header').offsetHeight;
        const elementPosition = compraSection.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
        
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    }
}

// AnimaciÃ³n del logo al cargar la pÃ¡gina
function animarLogo() {
    const logo = document.querySelector('.logo-container img');
    if (logo) {
        logo.classList.add('logo-animation');
    }
}

// Contador de visitas simulado con localStorage
function contadorVisitas() {
    let visits = localStorage.getItem('prosazestos_visits');
    visits = visits ? parseInt(visits) + 1 : 1;
    localStorage.setItem('prosazestos_visits', visits);
    
    if (visits > 1) {
        // Si es visitante recurrente, mostrar mensaje de bienvenida
        setTimeout(() => {
            const welcomeBack = document.createElement('div');
            welcomeBack.className = 'welcome-back';
            welcomeBack.innerHTML = `<p>Â¡Bienvenido de nuevo! Esta es tu visita #${visits}.</p>`;
            document.body.appendChild(welcomeBack);
            
            setTimeout(() => {
                welcomeBack.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                welcomeBack.classList.remove('show');
                setTimeout(() => {
                    welcomeBack.remove();
                }, 500);
            }, 4000);
        }, 2000);
    }
}

// Mostrar hora de Ãºltimo pedido (simulado)
function mostrarUltimaCompra() {
    const compraSection = document.getElementById('compra');
    if (!compraSection) return;
    
    const ultimaCompraElement = document.createElement('div');
    ultimaCompraElement.className = 'last-purchase';
    
    // Generar tiempo aleatorio en los Ãºltimos 30 minutos
    const minutos = Math.floor(Math.random() * 30) + 1;
    ultimaCompraElement.innerHTML = `<p>Ãšltimo pedido realizado hace ${minutos} minutos en ${generarCiudadAleatoria()}</p>`;
    
    // AÃ±adir despuÃ©s de la info de compra
    const compraInfo = document.querySelector('.compra-info');
    if (compraInfo) {
        compraInfo.appendChild(ultimaCompraElement);
    }
}

function generarCiudadAleatoria() {
    const ciudades = ['Madrid', 'Barcelona', 'Valencia', 'Sevilla', 'Bilbao', 'MÃ¡laga', 'Zaragoza'];
    return ciudades[Math.floor(Math.random() * ciudades.length)];
}

// Inicializar todo cuando el DOM estÃ© cargado
document.addEventListener('DOMContentLoaded', () => {
    startAutoSlide();
    updateCarousel();
    animarLogo();
    iniciarContadorDisponibilidad();
    contadorVisitas();
    mostrarUltimaCompra();
    
    // AÃ±adir clases necesarias para animaciones CSS
    document.body.classList.add('js-enabled');
});

// Detectar si el usuario intenta abandonar la pÃ¡gina
window.addEventListener('beforeunload', (e) => {
    const isScrolled = window.scrollY > 0;
    const isProduct = document.querySelector('.product-info') !== null;
    
    // Solo mostrar diÃ¡logo si el usuario ha bajado y visto el producto
    if (isScrolled && isProduct) {
        // Esto mostrarÃ¡ un diÃ¡logo estÃ¡ndar del navegador
        e.preventDefault();
        e.returnValue = '';
    }
});

// AÃ±adir funcionalidad de zoom al pasar el ratÃ³n para las imÃ¡genes del carrusel
const carouselImages = document.querySelectorAll('.carousel-images img');
carouselImages.forEach(img => {
    img.addEventListener('mousemove', function(e) {
        const { left, top, width, height } = this.getBoundingClientRect();
        const x = (e.clientX - left) / width;
        const y = (e.clientY - top) / height;
        
        this.style.transformOrigin = `${x * 100}% ${y * 100}%`;
        this.style.transform = 'scale(1.2)';
    });
    
    img.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
});